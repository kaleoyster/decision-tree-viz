<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title> Force Directed Graph For Bridge Decision Tree </title>
        <meta name='description' content ="The HTML 5"/>
        <meta name="author" content="SitePoint"/>
    </head>

<style type="text/css">
    #menu {
        margin: 10px;
    }

    #content div {
        display: inline-block;
        margin: 2px;
        background-color: orange;
        color:white;
        padding: 8px;
        height: 14px;
        text-align: center;
    }

    .tooltip {
      fill: white;
      font-family: sans-serif;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid gray;
    }
    
    .tooltip_node{
      fill: deepskyblue;
      color: white;
      font-family: sans-serif;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid crimson;
    }
    
    h5 {text-align: center;}

</style>

    <body>
        <div id="viz"></div>
        <button onclick='draw()'> Generate Visualization </button>
        <button onclick='stop()'> Stop Visualization </button>
        <svg id="svgID" width="1000", height="1000"> </svg>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script type="module" src="./data.js"></script>

        <script>
            //import { generateData } from './data.js';

            // (Generate) -> draw() -> generateForBridges() -> 
            function draw(){
                // var graphData = dataForBridges(); // function to generate the graphdata
                dataForBridges(); // function to generate the graphdat
                //drawUtility(graphData)
                }

            function drawUtility(graphData) {
                //simulation.stop();
                const scale = d3.scaleOrdinal(d3.schemeCategory10)
                const color = d => scale(d.group)
                var svg =  d3.select("svg");
                var width = svg.attr("width");
                var height = svg.attr("height");
               
                var simulation = d3
                .forceSimulation(graphData.nodes)
                .force("charge", d3.forceManyBody().strength(-30))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("link", d3.forceLink(graphData.links).id(function(d){
                                    return d.id;
                                }))
                .alphaTarget(1) 
                .on("tick", ticked);
  
                var nodes = svg
                .append("g")
                .selectAll("circle")
                .data(graphData.nodes)
                .enter()
                .append("circle")
                .attr("r", d => d.group*6)
                .attr("fill", color)
                .on("mouseover", tooltip_node_in)
                .on("mouseout", tooltip_node_out);

                var links = svg
                .append("g")
                .selectAll("line")
                .data(graphData.links)
                .enter()
                .append("line")
                .attr("stroke-width", (d) => d.value)
                .style("stroke", "black")
                .on("mouseover", tooltip_in)
                .on("mouseout", tooltip_out);
    
                var texts = svg
                .append("g")
                .selectAll("text")
                .data(graphData.nodes)
                .enter()
                .append("text")
                .text(d=>d.id);
    
                var drag = d3
                .drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
    
                nodes.call(drag);

            // new
            let tooltip = d3
                .select("body")
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("background-color", "grey")
                .style("color", "white")
                .style("text-shadow", "1px 1px 1px #000000")
                .attr("class", "tooltip");

            // new (node) 
            let tooltip_node = d3
                .select("body")
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("background-color", "crimson")
                .style("text-shadow", "1px 1px 1px #000000")
                .attr("class", "tooltip_node");

            function tooltip_in(event, d) {
                return tooltip
                    .html(
                        `<h4> Source: ${d.source.id} </h4>
                         <h4> Target: ${d.target.id} </h4>
                         <h4> Target: ${d.value} </h4>`
                    )
                    .style("visibility", "visible")
                    .style("top", event.pageY + "px")
                    .style("left", event.pageX + "px");
            }

            function tooltip_out() {
                return tooltip
                    .transition()
                    .duration(100)
                    .style("visibility", "hidden");
            }

            // new (node)
            function tooltip_node_in(event, d) {
                return tooltip_node
                    .html(
                        `<h4> ${d.id} </h4>`
                    )
                    .style("visibility", "visible")
                    .style("top", event.pageY + "px")
                    .style("left", event.pageX + "px");
            }

            // new (node)
            function tooltip_node_out() {
                return tooltip_node
                    .transition()
                    .duration(100)
                    .style("visibility", "hidden");
            }
                                
            // Done
            function ticked(){
                    texts
                        .attr("x", d=>d.x)
                        .attr("y", d=>d.y);
    
                    nodes
                        .attr('cx', function(d){
                                        return d.x;
    
                                    })
                        .attr('cy', function(d){
                                        return d.y;
    
                                    });
                    links
                        .attr('x1', function(d){
                                        return d.source.x;
                                    })
    
                        .attr('y1', function(d){
                                        return d.source.y;
                                    })
    
                        .attr('x2', function(d){
                                        return d.target.x;
                                    })
    
                        .attr('y2', function(d){
                                        return d.target.y;
                                    });
    
             }

            // Done
            function dragstarted(event){
                if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
             }
            
            // Done
            function dragged(event){
                event.subject.fx = event.x;
                event.subject.fy = event.y;
             }

            // Done
            function dragended(event){
                if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
              }
            }

            // TODO: This where the data will go
            function redraw(){
                // redraw (update the visualization)
            }
 
            function dataForBridges(){
                // var graphData = generateData();

               var graphData = {
                    nodes: [
                            {"id":'Bridge 1', "group":1},
                            {"id":'Bridge 2', "group":2},
                            {"id":'Bridge 3', "group":3},
                            {"id":'Bridge 4', "group":2},
                            {"id":'Bridge 5', "group":1},
                            {"id":'Bridge 6', "group":1},
                            ],

                    links: [
                        {"source":'Bridge 1',
                         "target":'Bridge 2', 
                         "value": 5},

                        {"source":'Bridge 2', 
                         "target":'Bridge 3', 
                         "value": 7},

                        {"source":'Bridge 3', 
                         "target":'Bridge 5', 
                         "value": 8},

                        {"source":'Bridge 4', 
                         "target":'Bridge 5', 
                         "value": 2},

                        {"source":'Bridge 5', 
                         "target":'Bridge 6', 
                         "value": 15},

                        {"source":'Bridge 6', 
                         "target":'Bridge 1', 
                         "value": 10},
                    ]
                };

                drawUtility(graphData);
                fetch('./data/network.json')
                   .then(response => response.json())
                   .then(result => {                                   
                                    drawUtility(result);
                               });
            
            // let data1 = data;
            //console.log(data1);
            //console.log(data1.length);
            //return graphData;
            }
            
       </script>
    </body>
    </html>
